###Q1 - Which support representative agent has sold the least###

SELECT e.EmployeeId Rep_id, SUM(i.total) Total_amt
FROM Employee e
JOIN Customer c
ON c.SupportRepId = e.EmployeeId
JOIN Invoice i
ON i.CustomerId = c.CustomerId
GROUP BY 1
ORDER BY 2;


###Q2 - What are the top five albums purchased, and in which country they are popular###

WITH tab1 AS (
          SELECT al.AlbumId Album_Id, al.Title Album_title, c.country  Country_name, COUNT(i.InvoiceId) count_invoice
          FROM Artist ar
          JOIN Album al
          ON ar.ArtistId = al.ArtistId
		  JOIN Track t
		  ON al.AlbumId = t.AlbumId
          JOIN InvoiceLine il
          ON t.trackid = il.trackid
          JOIN Invoice i
          ON i.InvoiceId = il.InvoiceId
          JOIN Customer c
          ON c.CustomerId = i.CustomerId
          GROUP BY 1, 3
          ORDER BY 2),

      tab2 AS (
           SELECT country_name, MAX(count_invoice) maximum
           FROM tab1
           GROUP BY 1)
SELECT tab1.count_invoice Num_purchases, tab1.Country_name Country, tab1.Album_title
FROM tab1
JOIN tab2
ON tab1.country_name = tab2.country_name AND tab1.count_invoice = tab2.maximum
ORDER BY 1 DESC
LIMIT 5;


###Q3 - Which Jazz band has released songs the most in USA###

SELECT  ar.Name Band, COUNT(*) Songs, c.Country
FROM Artist ar
JOIN Album al
ON ar.ArtistId = al.ArtistId
JOIN Track t
ON t. AlbumId = al.AlbumId
JOIN Genre g
ON g.GenreId = t.GenreId
JOIN InvoiceLine il
ON il.TrackId = t.TrackId
JOIN Invoice i
ON i.InvoiceId = il.InvoiceId
JOIN Customer c
ON c.CustomerId = i.CustomerId
WHERE c.Country = "USA" AND g.GenreId = 2
GROUP BY 1,3
ORDER BY 2 DESC;


###Q4 - Who are the best three customers###

SELECT c.CustomerId, SUM(total) Total_amt
FROM Customer c
JOIN Invoice i
ON i.CustomerId = c.CustomerId
GROUP BY 1
ORDER BY 2 DESC
LIMIT 3;

###Q5 - Which year has the highest volume of Alternative & Punk music purchases###

SELECT strftime('%Y',i.InvoiceDate) AS Year, COUNT(*) Count_invoices
FROM Customer c
JOIN Invoice i
ON i.CustomerId = c.CustomerId
JOIN InvoiceLine il
ON i.InvoiceId = il.InvoiceId
JOIN Track t
ON t.TrackId = il.TrackId
JOIN genre g
ON g.GenreId = t.GenreId
WHERE g.GenreId = 4
GROUP BY 1
ORDER BY 2 DESC;

